# API va Frontend Xavfsizlik Auditi (Knowhub)

## 1. Backend (Laravel API v1)
- **Marshrutlar va himoya**: `routes/api.php` dagi `auth:sanctum` va `RateLimitMiddleware` faqat autentifikatsiya qilingan blokda qo'llanadi; login/registratsiya public, qolgan public yo'laklar (postlar, qidiruv, statistikalar) cheklovsiz ochiq. Bu bot trafik va scraping uchun ochiq; agar kerak bo'lsa rate-limit yoki cache bilan himoya qilish tavsiya etiladi.【F:routes/api.php†L43-L193】
- **Post/Comment/Vote**: post yaratish/yangilash/o'chirish, komment qo'shish va ovoz berish qat'iy `auth:sanctum` bilan yopilgan; `PostStoreRequest` va `PostUpdateRequest` orqali validatsiya ishlaydi, slug avtomatik generatsiya bo'ladi, shuning uchun mass assignment xavfi past. Post va kommentlar `votes()` polymorf munosabatiga ega bo'lgani uchun `withCount('votes')` xatolarsiz ishlaydi.【F:routes/api.php†L121-L134】
- **Profil va dashboard**: `/profile/me` autentifikatsiya ostida; ommaviy profil ko'rish public. `ProfileController@update` validatsiya talablariga rioya qilayotganini tekshirish kerak, ammo yo'l himoyalangan. Public profil uchun shablon regex `/me` bilan to'qnashmaydi.【F:routes/api.php†L76-L190】
- **Containerlar**: barcha container CRUD va fayl operatsiyalari `auth:sanctum` va policy orqali `authorize(...)` bilan cheklangan (`ContainerFileController`da `view`/`update` polisi qo'llanadi). Biroq public API darajasida qo'shimcha rate-limit yo'q; resurs og'irligi yuqori bo'lsa limit qo'shish tavsiya etiladi.【F:routes/api.php†L92-L118】
- **CSRF/HTTPS**: `AppServiceProvider` `forceScheme('https')` va `HTTPS=on` ni sozlaydi; bu proxydan kelayotgan HTTPS trafikni to'g'ri tanish va CSRF cookie'lari `secure` bo'lishini ta'minlaydi.【F:app/Providers/AppServiceProvider.php†L46-L62】
- **CORS/SameSite**: `config/cors.php` subdomainlar uchun `https://*.space.knowhub.uz` va `supports_credentials=true` bilan moslashtirilgan; `config/session.php` `same_site`ni env orqali boshqaradi, shu sababli `.env` da `SESSION_SAME_SITE=none` va `SESSION_DOMAIN=.space.knowhub.uz` to'g'ri berilmasa 419 xato yuzaga kelishi mumkin.【F:config/cors.php†L7-L52】【F:config/session.php†L191-L219】

## 2. Frontend (Next.js)
- **Auth oqimi**: `AuthProvider` tokenni `localStorage` va cookie orqali saqlaydi; login/registratsiya `api.post('/auth/login')` va `api.post('/auth/register')` ga JSON body orqali yuboriladi (query-string ishlatilmaydi), bu xavfsizroq.【F:frontend/src/providers/AuthProvider.tsx†L25-L123】
- **CSRF/SameSite**: Token cookie sifatida ham saqlanadi (`setAuthCookie`), shu bois backendda `SESSION_DOMAIN` va `SESSION_SAME_SITE=none` (yoki `lax` va yagona domenda) to'g'ri bo'lmasa, secure cookie tashlanmaydi va 419 xato qaytadi. Frontend `buildApiUrl` bilan OAuth redirect havolalarini `/auth/google/redirect` va `/auth/github/redirect` ga yuboradi; HTTPS majburiyligi bilan mos keladi.【F:frontend/src/app/auth/login/page.tsx†L31-L119】
- **API chaqiruvlari**: `useAuth` `api` instansiyasiga Authorization bearer header qo'shadi va `/profile/me` ni tekshiradi; bu server-komponentlarda emas, client tarafda ishlaydi, shuning uchun SSR sahifalarida autentifikatsiya kerak bo'lsa qo'shimcha tekshiruv talab etiladi.【F:frontend/src/providers/AuthProvider.tsx†L43-L115】

## 3. Aniqlangan xavf va tavsiyalar
1. **Public endpointlar rate-limit**: Public `/posts`, `/users`, `/tags`, `/activity-feed`, `/search` kesh yoki rate-limit bilan himoyalanmagan. Cloudflare/Nginx darajasida yoki middleware bilan limitlash, yoki javoblarni cache qilishni yoqing.【F:routes/api.php†L162-L191】
2. **CSRF 419 muammosi**: Proxy ortida HTTPS majburlash kiritilgan, lekin `.env` dagi `SESSION_DOMAIN=.space.knowhub.uz`, `SESSION_SECURE_COOKIE=true`, `SESSION_SAME_SITE=none`/`lax` va `SANCTUM_STATEFUL_DOMAINS` subdomainlarni o'z ichiga olishini tekshirish zarur. Aks holda frontenddan kelgan cookie tashlanadi va 419 yuz beradi.【F:app/Providers/AppServiceProvider.php†L46-L62】【F:config/session.php†L191-L219】
3. **Frontend token saqlash**: Token `localStorage`da ham saqlanadi (XSS holatlarida o'g'irlanishi mumkin). Faqat httpOnly cookie bilan ishlatish yoki localStorage versiyasini cheklash tavsiya etiladi. Kirish formasi JSON body ishlatadi, shuning uchun parol URL queryda yo'q.【F:frontend/src/providers/AuthProvider.tsx†L25-L123】
4. **SSR va credential uzatish**: Ko'p sahifalar client komponenti sifatida API chaqiradi; SSR sahifalar (`getServerSideProps` yo'q) tokenni avtomatik uzatmaydi. Agar server-render kerak bo'lsa, `cookies()` yoki `headers()` orqali tokenni yuborish mexanizmini qo'shish lozim (aks holda 401 yoki flash content paydo bo'lishi mumkin).【F:frontend/src/providers/AuthProvider.tsx†L43-L115】
5. **File upload/service endpointlari**: Container fayl va lifecycle endpointlari faqat auth bilan cheklangan, lekin qo'shimcha audit: yuklanadigan fayl hajmi/typi uchun validation mavjud emas (ContainerFileController `file` uchun max size/type belgilamagan). Katta yoki zararli faylni yuklashdan himoyalanish uchun `mimes`, `max`, va virus skan/limit qo'shish tavsiya etiladi.【F:app/Http/Controllers/Api/V1/ContainerFileController.php†L11-L77】

## 4. CSRF/HTTPS bo'yicha amaliy qadamlar
- Nginx yoki aaPanel proxysi `X-Forwarded-Proto=https` headerini uzatayotganini tekshiring; `AppServiceProvider` majburiy httpsni qo'llaydi, shu bilan secure cookie ishlaydi.【F:app/Providers/AppServiceProvider.php†L46-L62】
- `.env` namunasi: `APP_URL=https://api.space.knowhub.uz`, `SESSION_DOMAIN=.space.knowhub.uz`, `SANCTUM_STATEFUL_DOMAINS=space.knowhub.uz,.space.knowhub.uz,api.space.knowhub.uz`, `SESSION_SAME_SITE=none`, `SESSION_SECURE_COOKIE=true`, `CORS_ALLOWED_ORIGINS=https://space.knowhub.uz,https://api.space.knowhub.uz`.

